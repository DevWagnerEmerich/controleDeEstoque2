(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))a(o);new MutationObserver(o=>{for(const r of o)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(o){const r={};return o.integrity&&(r.integrity=o.integrity),o.referrerPolicy&&(r.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?r.credentials="include":o.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function a(o){if(o.ep)return;o.ep=!0;const r=n(o);fetch(o.href,r)}})();const{createClient:Je}=supabase,Qe="https://edaednirrvsuvilnopbt.supabase.co",Xe="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVkYWVkbmlycnZzdXZpbG5vcGJ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0NzkwOTUsImV4cCI6MjA3OTA1NTA5NX0.ureEiq2Pzfj13vooKon9nAx9NHisAkE-ri6pTjDlIZY",y=Je(Qe,Xe);let he=null;async function oe(e){if(!e)return null;try{const{data:t,error:n}=await y.from("profiles").select("role, is_active").eq("id",e.id);if(n)throw n;return!t||t.length===0?(console.error("Nenhum perfil encontrado para o usuário ID:",e.id),null):{...e,role:t[0].role}}catch(t){return console.error("Erro ao buscar perfil do usuário:",t.message),null}}function re(e){he=e}function L(){return he}async function Ee(e,t){const{data:n,error:a}=await y.auth.signInWithPassword({email:e,password:t});if(a)return console.error("Erro no login:",a.message),document.getElementById("login-error").textContent="Email ou palavra-passe inválidos.",{user:null,error:a};const o=await oe(n.user);return o&&o.is_active===!1?(console.warn("Login blocked: User is not active."),await y.auth.signOut(),{user:null,error:{message:"Sua conta ainda não foi aprovada pelo administrador."}}):{user:n.user,error:null}}async function U(){const{error:e}=await y.auth.signOut();e&&console.error("Erro no logout:",e),window.location.hash="",window.location.reload()}function _(e){const t=L();if(!t)return console.warn("checkPermission chamado sem perfil de usuário."),!1;if(t.role==="admin")return!0;if(t.permissions&&typeof t.permissions=="object"){if(t.permissions[e]===!0)return!0;if(t.permissions[e]===!1)return!1}return t.role==="user"?["reports","operation","simulate"].includes(e):!1}async function Ke(e,t,n,a){const{data:o,error:r}=await y.functions.invoke("create-user",{body:{email:e,password:t,role:n,permissions:a}});if(r){if(console.error("Erro na Edge Function:",r),r.context&&typeof r.context.json=="function")try{const i=await r.context.json();if(i&&i.error)return{error:{message:i.error}}}catch(i){console.warn("Não foi possível ler o corpo do erro da função:",i)}return r.message&&r.message.includes("FunctionsFetchError")?{error:{message:"A função de criação de usuários (Edge Function) não está implantada."}}:{error:r}}return{data:o,error:null}}async function Ge(e,t){const n={userId:e,...t},{data:a,error:o}=await y.functions.invoke("update-user",{body:n});if(o){if(console.error("Erro na Edge Function update-user:",o),o.context&&typeof o.context.json=="function")try{const r=await o.context.json();if(r&&r.error)return{error:{message:r.error}}}catch{}return{error:o}}return{data:a,error:null}}const Ye=Object.freeze(Object.defineProperty({__proto__:null,checkPermission:_,createUser:Ke,fetchUserProfile:oe,getCurrentUserProfile:L,handleLogin:Ee,handleLogout:U,setCurrentUserProfile:re,supabaseClient:y,updateUser:Ge},Symbol.toStringTag,{value:"Module"}));let u=[],v=[],k=[],I=[],O=[],b=[];function We(e){u.push(e)}function Ie(e){const t=u.findIndex(n=>n.id===e.id);t!==-1&&(u[t]=e)}function Ze(e){const t=u.findIndex(n=>n.id===e);t!==-1&&u.splice(t,1)}function et(e){v.push(e)}function tt(e){const t=v.findIndex(n=>n.id===e.id);t!==-1&&(v[t]=e)}function nt(e){const t=v.findIndex(n=>n.id===e);t!==-1&&v.splice(t,1)}function at(e){k.push(e)}async function ie(e){const{data:t,error:n}=await y.from("items").insert([e]).select().single();if(n)throw console.error("Erro ao adicionar item:",JSON.stringify(n,null,2)),n;return t}async function we(e,t){const{data:n,error:a}=await y.from("items").update(t).eq("id",e).select().single();if(a)throw console.error("Erro ao atualizar item:",JSON.stringify(a,null,2)),a;return n}async function ot(e){const{error:t}=await y.from("items").delete().eq("id",e);if(t)throw console.error("Erro ao deletar item:",JSON.stringify(t,null,2)),t;return!0}async function be(e){const{data:t,error:n}=await y.from("suppliers").insert([e]).select().single();if(n)throw console.error("Erro ao adicionar fornecedor:",JSON.stringify(n,null,2)),n;return t}async function rt(e,t){const{data:n,error:a}=await y.from("suppliers").update(t).eq("id",e).select().single();if(a)throw console.error("Erro ao atualizar fornecedor:",JSON.stringify(a,null,2)),a;return n}async function it(e){const{error:t}=await y.from("suppliers").delete().eq("id",e);if(t)throw console.error("Erro ao deletar fornecedor:",JSON.stringify(t,null,2)),t;return!0}async function Z(e){const{data:t,error:n}=await y.from("movements").insert([e]).select().single();if(n)throw console.error("Erro ao adicionar movimento:",JSON.stringify(n,null,2)),n;return t}async function se(e){const{data:t,error:n}=await y.from("operations").insert([e]).select().single();if(n)throw console.error("Erro ao adicionar operação:",JSON.stringify(n,null,2)),n;return t}async function st(e,t){const{data:n,error:a}=await y.from("operations").update(t).eq("id",e).select().single();if(a)throw console.error("Erro ao atualizar operação:",JSON.stringify(a,null,2)),a;return n}async function ct(e){const{data:t,error:n}=await y.from("purchase_orders").insert([e]).select().single();if(n)throw console.error("Erro ao adicionar Ordem de Compra:",JSON.stringify(n,null,2)),n;return t}async function Be(e,t){const{data:n,error:a}=await y.from("purchase_orders").update(t).eq("id",e).select().single();if(a)throw console.error("Erro ao atualizar Ordem de Compra:",JSON.stringify(a,null,2)),a;return n}async function ce(){console.log("Iniciando o carregamento de dados do Supabase...");const{data:e,error:t}=await y.from("items").select("*");if(t)throw new Error(`Erro ao buscar itens: ${t.message}`);const{data:n,error:a}=await y.from("suppliers").select("*");if(a)throw new Error(`Erro ao buscar fornecedores: ${a.message}`);const{data:o,error:r}=await y.from("operations").select("*");if(r)throw new Error(`Erro ao buscar operações: ${r.message}`);const{data:i,error:c}=await y.from("movements").select("*");if(c)throw new Error(`Erro ao buscar movimentos: ${i.message}`);const{data:s,error:l}=await y.from("purchase_orders").select("*");if(l)throw new Error(`Erro ao buscar Ordens de Compra: ${l.message}`);const{data:p,error:m}=await y.from("profiles").select("*");m&&console.warn(`Aviso ao buscar perfis: ${m.message}`),u.length=0,v.length=0,I.length=0,k.length=0,b.length=0,O.length=0,u.push(...e),v.push(...n),I.push(...o),k.push(...i),b.push(...s),p&&O.push(...p),console.log("Dados carregados com sucesso do Supabase:"),console.log(`  - ${u.length} itens`),console.log(`  - ${v.length} fornecedores`),console.log(`  - ${I.length} operações`),console.log(`  - ${k.length} movimentos`),console.log(`  - ${b.length} Ordens de Compra`)}async function dt(e){const{error:t}=await y.from("purchase_orders").delete().eq("id",e);if(t)throw console.error("Erro ao deletar Ordem de Compra:",JSON.stringify(t,null,2)),t;return!0}async function lt(e,t){const{data:n,error:a}=await y.functions.invoke("update-user",{body:{userId:e,is_active:t}});if(a)throw console.error("Erro ao atualizar status do usuário (Edge Function):",JSON.stringify(a,null,2)),a;return n}const ut="modulepreload",mt=function(e){return"/"+e},me={},pt=function(t,n,a){let o=Promise.resolve();if(n&&n.length>0){document.getElementsByTagName("link");const i=document.querySelector("meta[property=csp-nonce]"),c=(i==null?void 0:i.nonce)||(i==null?void 0:i.getAttribute("nonce"));o=Promise.allSettled(n.map(s=>{if(s=mt(s),s in me)return;me[s]=!0;const l=s.endsWith(".css"),p=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${p}`))return;const m=document.createElement("link");if(m.rel=l?"stylesheet":ut,l||(m.as="script"),m.crossOrigin="",m.href=s,c&&m.setAttribute("nonce",c),document.head.appendChild(m),l)return new Promise((g,E)=>{m.addEventListener("load",g),m.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${s}`)))})}))}function r(i){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=i,window.dispatchEvent(c),!c.defaultPrevented)throw i}return o.then(i=>{for(const c of i||[])c.status==="rejected"&&r(c.reason);return t().catch(r)})};function S(e){return e?String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):""}document.addEventListener("operation-saved",()=>{K()});function V(e){return e?String(e).replace(/\D/g,""):""}function ke(e){return e?(e=e.replace(/\D/g,""),e=e.replace(/^(\d{2})(\d)/,"$1.$2"),e=e.replace(/^(\d{2})\.(\d{3})(\d)/,"$1.$2.$3"),e=e.replace(/\.(\d{3})(\d)/,".$1/$2"),e=e.replace(/(\d{4})(\d)/,"$1-$2"),e):""}function xe(e){return e?(e=e.replace(/\D/g,""),e=e.replace(/^(\d{2})(\d)/g,"($1) $2"),e=e.replace(/(\d)(\d{4})$/,"$1-$2"),e):""}function Se(e){return e?(e=e.replace(/\D/g,""),e=e.replace(/^(\d{4})(\d)/,"$1.$2"),e=e.replace(/^(\d{4})\.(\d{2})(\d)/,"$1.$2.$3"),e):""}const ee=e=>e.quantity<=0?{text:"Esgotado",class:"bg-gray-200 text-gray-800",level:3}:e.quantity<=e.min_quantity?{text:"Crítico",class:"bg-red-100 text-red-800",level:2}:e.quantity<=e.min_quantity*1.2?{text:"Baixo",class:"bg-yellow-100 text-yellow-800",level:1}:{text:"OK",class:"bg-green-100 text-green-800",level:0},T=(e,t="USD")=>{const n={style:"currency",currency:t,minimumFractionDigits:2},a=t==="BRL"?"pt-BR":"en-US";return new Intl.NumberFormat(a,n).format(e||0)};function N(){const e=document.getElementById("items-grid-container"),t=document.getElementById("empty-state");e.innerHTML="";let n=[...u];const a=document.getElementById("searchInput").value.toLowerCase();a&&(n=n.filter(s=>s.name.toLowerCase().includes(a)||s.name_en&&s.name_en.toLowerCase().includes(a)||s.code&&s.code.toLowerCase().includes(a)));const o=document.getElementById("filterSelect").value;o!=="all"&&(n=n.filter(s=>ee(s).text.toLowerCase()===o));const r=document.getElementById("sortSelect").value;n.sort((s,l)=>{switch(r){case"name-asc":return s.name.localeCompare(l.name);case"name-desc":return l.name.localeCompare(s.name);case"qty-asc":return s.quantity-l.quantity;case"qty-desc":return l.quantity-s.quantity;default:return 0}}),n.length===0?(t.classList.remove("hidden"),e.classList.add("hidden")):(t.classList.add("hidden"),e.classList.remove("hidden"));const i=_("edit"),c=_("delete");n.forEach(s=>{const l=ee(s),p=s.units_per_package>0?Math.floor(s.quantity/s.units_per_package):0,m=s.package_type==="fardo"?"Fardos":"Caixas",g=`${p} ${m}`,E=document.createElement("div");E.className="product-card",E.innerHTML=`
            <div class="card-header">
                <img src="${s.image_url||"https://placehold.co/100x100/F9FAFB/1F2937?text="+S(s.name.charAt(0))}" alt="${S(s.name)}" class="card-image">
                <div class="card-actions">
                    <button data-action="open-item" data-id="${s.id}" class="card-action-button" ${i?"":"disabled"} title="Editar Item"><i data-feather="edit-2"></i></button>
                    <button data-action="delete-item" data-id="${s.id}" class="card-action-button danger" ${c?"":"disabled"} title="Excluir Item"><i data-feather="trash-2"></i></button>
                </div>
            </div>
            <div class="card-body">
                <h3 class="card-title">${S(s.name)}</h3>
                <p class="card-code">${S(s.code||"N/A")}</p>
                <div class="card-info-row">
                    <span class="card-info-label">Preço Venda</span>
                    <span class="card-info-value">${T(s.sale_price,"BRL")}</span>
                </div>
                <div class="card-info-row">
                    <span class="card-info-label">Stock</span>
                    <span class="card-info-value">${g}</span>
                </div>
            </div>
            <div class="card-footer">
                 <span class="status-badge status-${l.text.toLowerCase()}">${l.text}</span>
                 <button data-action="open-stock" data-id="${s.id}" class="add-stock-button">Adicionar Stock</button>
            </div>
        `,E.querySelector(".card-body").addEventListener("click",()=>gt(s.id)),E.querySelector('[data-action="open-stock"]').addEventListener("click",()=>Et(s.id)),E.querySelector('[data-action="open-item"]').addEventListener("click",x=>{x.stopPropagation(),te(s.id)}),E.querySelector('[data-action="delete-item"]').addEventListener("click",x=>{x.stopPropagation(),yt(s.id)}),e.appendChild(E)}),feather.replace()}function ft(){const e=document.getElementById("dashboard-stats");if(!e)return;const t=u.length,n=u.reduce((i,c)=>i+c.quantity*c.cost_price,0),a=u.filter(i=>i.quantity>0&&i.quantity<=i.min_quantity).length,o=u.filter(i=>i.quantity<=0).length,r=[{label:"Valor Total do Stock",value:T(n,"BRL"),icon:"dollar-sign"},{label:"Itens Totais",value:t,icon:"package"},{label:"Itens com Stock Baixo",value:a,icon:"trending-down"},{label:"Itens Esgotados",value:o,icon:"alert-triangle"}];e.innerHTML=r.map(i=>`
        <div class="stat-card">
            <div class="stat-icon-wrapper">
                <i data-feather="${i.icon}"></i>
            </div>
            <div class="stat-info">
                <span class="stat-value">${i.value}</span>
                <span class="stat-label">${i.label}</span>
            </div>
        </div>
    `).join(""),feather.replace()}function P(){ft(),N(),_e(),de()}let H=null;function B(e){const t=document.getElementById(e);if(t){H=document.activeElement,document.body.classList.add("modal-is-open"),t.classList.add("is-open"),t.setAttribute("aria-hidden","false");const n=t.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');n&&n.focus(),feather.replace()}}function w(e){const t=document.getElementById(e);t&&(document.body.classList.remove("modal-is-open"),t.classList.remove("is-open"),t.setAttribute("aria-hidden","true"),H&&(H.focus(),H=null),history.pushState("",document.title,window.location.pathname+window.location.search),setTimeout(()=>{[...document.querySelectorAll(".main-view")].some(a=>!a.classList.contains("hidden"))||X("dashboard")},300))}function M(e,t,n){document.getElementById("confirm-modal-title").innerText=e,document.getElementById("confirm-modal-text").innerText=t;const a=document.getElementById("confirm-modal-btn"),o=a.cloneNode(!0);a.parentNode.replaceChild(o,a),o.addEventListener("click",()=>{typeof n=="function"&&n(),w("confirm-modal")}),B("confirm-modal")}function gt(e){const t=u.find(c=>c.id===e);if(!t)return;const n=v.find(c=>c.id===t.supplier_id),a=t.cost_price>0?(t.sale_price-t.cost_price)/t.cost_price*100:0,o=t.units_per_package>0?Math.floor(t.quantity/t.units_per_package):0;document.getElementById("details-item-name").innerText=t.name,document.getElementById("details-item-name-en").innerText=t.name_en||"",document.getElementById("details-item-image").src=t.image_url||`https://placehold.co/300x300/e0e7ff/4f46e5?text=${t.name.charAt(0)}`,document.getElementById("details-item-cost").innerText=T(t.cost_price,"BRL"),document.getElementById("details-item-sale").innerText=T(t.sale_price,"BRL"),document.getElementById("details-item-margin").innerText=`${a.toFixed(1)}%`,document.getElementById("details-item-description").innerText=t.description||"Nenhuma descrição fornecida.",document.getElementById("details-item-quantity").innerText=t.quantity,document.getElementById("details-item-supplier").innerText=n?n.name:"Não especificado",document.getElementById("details-item-code").innerText=t.code||"N/A",document.getElementById("details-item-ncm").innerText=t.ncm?Se(t.ncm):"N/A",document.getElementById("details-item-qty-unit").innerText=t.qty_unit?t.qty_unit.toFixed(2):"N/A",document.getElementById("details-item-boxes").innerText=o,document.getElementById("details-package-type-label").innerText=`Total de ${t.package_type}s`;const r=document.getElementById("details-item-history");r.innerHTML="";const i=k.filter(c=>c.item_id===e).sort((c,s)=>new Date(s.date)-new Date(c.date)).slice(0,5);i.length===0?r.innerHTML='<p class="text-secondary text-center py-4">Nenhuma movimentação para este item.</p>':i.forEach(c=>{const s=document.createElement("div");s.className=`report-movement-item ${c.type}`,s.innerHTML=`
                <div class="movement-info">
                    <span class="font-bold uppercase">${c.type==="in"?"Entrada":"Saída"}</span>
                    <span class="text-secondary">(${c.quantity} un.)</span>
                    ${c.operation_id?`<span class="movement-op">(${c.operation_id})</span>`:""}
                </div>
                <span class="movement-date">${new Date(c.date).toLocaleString("pt-BR")}</span>
            `,r.appendChild(s)}),B("item-details-modal")}async function te(e=null){if(e&&!_("edit")){d("Não tem permissão para editar itens.","danger");return}if(!e&&!_("add")){d("Não tem permissão para adicionar itens.","danger");return}const t=document.getElementById("item-form");t.reset(),document.getElementById("itemId").value="",$e(null,"imagePreview","imagePlaceholder");const n=document.getElementById("itemSupplier");if(n.innerHTML='<option value="">Sem fornecedor</option>',v.forEach(a=>{n.innerHTML+=`<option value="${a.id}">${a.name}</option>`}),e){const a=u.find(o=>o.id===e);if(a){document.getElementById("item-modal-title").innerText="Editar Item",document.getElementById("itemId").value=a.id,document.getElementById("itemName").value=a.name,document.getElementById("itemNameEn").value=a.name_en,document.getElementById("itemCode").value=a.code,document.getElementById("itemNcm").value=Se(a.ncm),document.getElementById("itemDescription").value=a.description;const o=a.units_per_package>0?a.quantity/a.units_per_package:0;if(document.getElementById("quantityInBoxes").value=o,document.getElementById("itemMinQuantity").value=a.min_quantity,document.getElementById("itemCostPrice").value=a.cost_price,document.getElementById("itemSalePrice").value=a.sale_price,document.getElementById("itemSupplier").value=a.supplier_id,document.getElementById("packageType").value=a.package_type||"caixa",document.getElementById("unitsPerPackage").value=a.units_per_package,document.getElementById("unitMeasureValue").value=a.unit_measure_value,document.getElementById("unitMeasureType").value=a.unit_measure_type||"g",a.image_url){const r=document.getElementById("imagePreview");r.src=a.image_url,r.classList.remove("hidden"),document.getElementById("imagePlaceholder").classList.add("hidden")}}}else document.getElementById("item-modal-title").innerText="Adicionar Novo Item";t.onsubmit=async a=>{a.preventDefault();const o=document.getElementById("itemName").value;if(!o){d("O nome do item é obrigatório.","warning");return}const r=document.getElementById("itemId").value;try{if(r){const i={name:o,name_en:document.getElementById("itemNameEn").value,code:document.getElementById("itemCode").value,ncm:document.getElementById("itemNcm").value.replace(/\D/g,""),description:document.getElementById("itemDescription").value,supplier_id:document.getElementById("itemSupplier").value||null,package_type:document.getElementById("packageType").value,units_per_package:parseInt(document.getElementById("unitsPerPackage").value,10),min_quantity:parseInt(document.getElementById("itemMinQuantity").value,10),cost_price:parseFloat(document.getElementById("itemCostPrice").value),sale_price:parseFloat(document.getElementById("itemSalePrice").value),unit_measure_value:parseFloat(document.getElementById("unitMeasureValue").value),unit_measure_type:document.getElementById("unitMeasureType").value},c=await we(r,i);Ie(c),d("Item atualizado com sucesso!","success")}else{const i=L();if(!i){d("Erro: Utilizador não autenticado. Por favor, faça login novamente.","danger");return}const c=parseInt(document.getElementById("unitsPerPackage").value,10),s=parseInt(document.getElementById("quantityInBoxes").value,10),l={user_id:i.id,name:o,code:document.getElementById("itemCode").value,ncm:document.getElementById("itemNcm").value.replace(/\D/g,""),description:document.getElementById("itemDescription").value,supplier_id:document.getElementById("itemSupplier").value||null,package_type:document.getElementById("packageType").value,units_per_package:c,quantity:s*c,min_quantity:parseInt(document.getElementById("itemMinQuantity").value,10),cost_price:parseFloat(document.getElementById("itemCostPrice").value),sale_price:parseFloat(document.getElementById("itemSalePrice").value),unit_measure_value:parseFloat(document.getElementById("unitMeasureValue").value),unit_measure_type:document.getElementById("unitMeasureType").value},p=await ie(l);We(p),d("Item adicionado com sucesso!","success")}P(),w("item-modal")}catch(i){d(`Erro ao salvar item: ${i.message}`,"danger")}},B("item-modal")}async function yt(e){if(!_("delete")){d("Não tem permissão para excluir itens.","danger");return}const t=u.find(n=>n.id===e);t&&M("Excluir Item?",`Tem a certeza de que deseja excluir o item "${t.name}"?`,async()=>{try{await ot(e),Ze(e),d("Item excluído com sucesso!","danger"),P()}catch(n){d(`Erro ao excluir o item: ${n.message}`,"danger")}})}async function pe(){F(),ne();const e=document.getElementById("supplier-form"),t=document.getElementById("supplierCnpj"),n=document.getElementById("supplierPhone");t.addEventListener("input",a=>{a.target.value=ke(a.target.value)}),n.addEventListener("input",a=>{a.target.value=xe(a.target.value)}),e.onsubmit=async a=>{a.preventDefault();const o=document.getElementById("supplierId").value,r=document.getElementById("supplierName").value;if(!r){d("O nome do fornecedor é obrigatório.","warning");return}const i={name:r,cnpj:document.getElementById("supplierCnpj").value.replace(/\D/g,""),address:document.getElementById("supplierAddress").value,fda:document.getElementById("supplierFda").value,email:document.getElementById("supplierEmail").value,salesperson:document.getElementById("supplierSalesperson").value,phone:document.getElementById("supplierPhone").value.replace(/\D/g,"")};try{if(o){const c=await rt(o,i);tt(c),d("Fornecedor atualizado com sucesso!","success")}else{const c=await be(i);et(c),d("Fornecedor adicionado com sucesso!","success")}F(),ne()}catch(c){d(`Erro ao salvar fornecedor: ${c.message}`,"danger")}},B("suppliers-modal")}function F(){const e=document.getElementById("suppliers-list");if(e.innerHTML="",v.length===0){e.innerHTML='<p class="text-secondary" style="text-align: center;">Nenhum fornecedor registado.</p>';return}v.forEach(t=>{const n=document.createElement("div");n.className="supplier-list-item",n.innerHTML=`
            <div onclick="editSupplier('${t.id}')" class="supplier-info">
                <span class="supplier-name">${t.name}</span>
                <p class="supplier-meta">${t.email||""}</p>
            </div>
            <button onclick="deleteSupplier('${t.id}', event)" class="btn-delete-supplier"><i data-feather="trash-2"></i></button>
        `,e.appendChild(n)}),feather.replace()}function vt(e){const t=v.find(n=>n.id===e);t&&(document.getElementById("supplier-form-title").innerText="Editar Fornecedor",document.getElementById("supplierId").value=t.id,document.getElementById("supplierName").value=t.name,document.getElementById("supplierCnpj").value=ke(t.cnpj),document.getElementById("supplierAddress").value=t.address,document.getElementById("supplierFda").value=t.fda,document.getElementById("supplierEmail").value=t.email,document.getElementById("supplierSalesperson").value=t.salesperson,document.getElementById("supplierPhone").value=xe(t.phone))}window.editSupplier=vt;function ne(){document.getElementById("supplier-form").reset(),document.getElementById("supplierId").value="",document.getElementById("supplier-form-title").innerText="Adicionar Novo Fornecedor"}async function ht(e,t){t.stopPropagation();const n=v.find(a=>a.id===e);n&&M("Excluir Fornecedor?",`Tem a certeza de que deseja excluir o fornecedor "${n.name}"?`,async()=>{try{await it(e),nt(e),F(),ne(),d("Fornecedor excluído!","danger")}catch(a){d(`Erro ao excluir fornecedor: ${a.message}`,"danger")}})}window.deleteSupplier=ht;async function Et(e){const t=u.find(o=>o.id===e);if(!t)return;const n=document.getElementById("stock-form");n.reset(),document.getElementById("stockItemId").value=e,document.getElementById("stock-modal-title").innerText=`Entrada Manual: ${t.name}`;const a=t.package_type==="fardo"?"Fardos":"Caixas";document.getElementById("movement-quantity-label").innerText=`Qtd. de ${a} a Adicionar`,n.onsubmit=async o=>{o.preventDefault();const r=document.getElementById("stockItemId").value,i=u.findIndex(g=>g.id===r);if(i===-1){d("Erro: Item não encontrado.","danger");return}const c=u[i],s=parseInt(document.getElementById("movementQuantity").value,10);if(isNaN(s)||s<=0){d("Por favor, insira uma quantidade numérica válida e positiva.","warning");return}const l=s*(c.units_per_package||1),p=c.quantity+l,m=document.getElementById("movementReason").value||"Entrada manual";try{const g=await we(r,{quantity:p}),E={item_id:r,type:"in",quantity:l,price:c.cost_price,reason:m,date:new Date().toISOString()},x=await Z(E);at(x),Ie(g),P(),w("stock-modal"),d(`Stock do item "${c.name}" atualizado com sucesso!`,"success")}catch(g){d(`Erro ao atualizar stock: ${g.message}`,"danger")}},B("stock-modal")}function d(e,t="info",n=3e3){const a=document.getElementById("notification-container"),o=document.createElement("div");o.className=`notification ${t}`,o.innerText=e,a.appendChild(o),setTimeout(()=>{o.classList.add("visible")},10),setTimeout(()=>{o.classList.remove("visible"),setTimeout(()=>o.remove(),500)},n)}function $e(e,t,n){const a=document.getElementById(t),o=document.getElementById(n);if(e&&e.target.files&&e.target.files[0]){const r=new FileReader;r.onload=i=>{a.src=i.target.result,a.classList.remove("hidden"),o&&o.classList.add("hidden")},r.readAsDataURL(e.target.files[0])}else a.src="#",a.classList.add("hidden"),o&&o.classList.remove("hidden")}async function fe(){const e=L();if(!e||e.role!=="admin"){d("Acesso negado.","danger");return}J(),Q(),B("users-modal");const t=document.getElementById("user-form");t.onsubmit=async n=>{n.preventDefault();const a=document.getElementById("userId").value,o=document.getElementById("formUsername").value,r=document.getElementById("formPassword").value,i="user",c={};if(document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(s=>{const l=s.id.replace("perm-","");c[l]=s.checked}),!a&&(!o||!r)){d("Email e Senha são obrigatórios para novos usuários.","warning");return}try{const{createUser:s,updateUser:l,supabaseClient:p}=await pt(async()=>{const{createUser:E,updateUser:x,supabaseClient:h}=await Promise.resolve().then(()=>Ye);return{createUser:E,updateUser:x,supabaseClient:h}},void 0);let m;if(a){d("Atualizando usuário...","info");const E={role:i,permissions:c};r&&console.warn("Edição de senha via Admin requer atualização na Edge Function."),m=await l(a,E)}else d("Criando usuário...","info"),m=await s(o,r,i,c);if(m.error)throw new Error(m.error.message||"Erro desconhecido ao salvar usuário.");d(a?"Usuário atualizado com sucesso!":"Usuário criado com sucesso!","success"),Q();const{data:g}=await p.from("profiles").select("*");g&&(O.length=0,O.push(...g),J()),w("users-modal")}catch(s){d(s.message,"danger")}}}function J(){const e=document.getElementById("users-list"),t=L();e.innerHTML="",O.forEach(n=>{const a=document.createElement("div");a.className="user-list-item",a.innerHTML=`
            <div onclick="editUser('${n.id}')" class="user-info">
                <span class="user-name">${S(n.username)||"Administrador"}</span>
                <p class="user-meta">${S(n.role)} ${n.is_active?'<span class="text-green-500">(Ativo)</span>':'<span class="text-red-500">(Pendente)</span>'}</p>
            </div>
            <div class="user-actions" style="display:flex; align-items:center; gap:10px;">
                ${n.is_active?`<button onclick="toggleUserStatus('${n.id}', false, event)" class="btn-icon" style="color: #F59E0B; border: 1px solid #F59E0B; padding: 4px; border-radius: 4px;" title="Bloquear Acesso"><i data-feather="slash"></i></button>`:`<button onclick="toggleUserStatus('${n.id}', true, event)" class="btn-icon" style="color: #10B981; border: 1px solid #10B981; padding: 4px; border-radius: 4px;" title="Ativar Acesso"><i data-feather="check-circle"></i></button>`}
                ${t&&t.email!==n.username?`<button onclick="deleteUser('${n.id}', event)" class="btn-icon" style="color: #EF4444; border: 1px solid #EF4444; padding: 4px; border-radius: 4px;" title="Excluir Usuário"><i data-feather="trash-2"></i></button>`:""}
            </div>
        `,e.appendChild(a)}),feather.replace()}function It(e){const t=O.find(n=>n.id===e);t&&(document.getElementById("user-form-title").innerText="Editar Usuário",document.getElementById("userId").value=t.id,document.getElementById("formUsername").value=t.username,document.getElementById("formUsername").disabled=!0,document.getElementById("formPassword").value="",document.getElementById("formPassword").placeholder="Deixe em branco para não alterar",document.querySelectorAll('#permissions-container input[type="checkbox"').forEach(n=>{const a=n.id.replace("perm-","");n.checked=!!(t.permissions&&t.permissions[a])}))}function wt(e,t,n){n&&n.stopPropagation(),lt(e,t).then(()=>{const a=O.find(o=>o.id===e);a&&(a.is_active=t),J(),d(`Usuário ${t?"ativado":"desativado"} com sucesso!`,"success")}).catch(a=>{d(`Erro ao atualizar status: ${a.message}`,"danger")})}window.toggleUserStatus=wt;window.editUser=It;function Le(e){if(!e)return;const t=(s,l)=>{const p=document.getElementById(s);p&&(p.tagName==="BUTTON"||p.tagName==="INPUT"?(p.disabled=!l,p.title=l?"":"Sem permissão",l?p.classList.remove("opacity-50","cursor-not-allowed"):p.classList.add("opacity-50","cursor-not-allowed")):p.style.display=l?"":"none")},n=_("admin")||e.role==="admin";t("menu-users",n),t("desktop-nav-users",n),t("nav-menu-users",n);const a=document.getElementById("menu-username");a&&(a.textContent=e.email);const o=_("add");t("add-item-btn-header",o),t("desktop-add-item-btn",o),t("empty-add-btn",o);const r=_("import");t("hub-import-op-btn",r),t("dropdown-import-op-btn",r),t("menu-purchase-orders",r),t("desktop-nav-purchase-orders",r);const i=_("operation");t("hub-simulate-op-btn",i),t("dropdown-simulate-op-btn",i);const c=_("reports");t("nav-reports",c),t("desktop-reports-btn",c),t("view-reports",c),typeof N=="function"&&N(),typeof F=="function"&&F()}window.applyPermissionsToUI=Le;function Q(){document.getElementById("user-form").reset(),document.getElementById("userId").value="",document.getElementById("formUsername").disabled=!1,document.getElementById("user-form-title").innerText="Adicionar Novo Usuário",document.getElementById("formPassword").placeholder="Palavra-passe",document.querySelectorAll('#permissions-container input[type="checkbox"]').forEach(e=>e.checked=!1)}function bt(e,t){t.stopPropagation();const n=L();if(!n||n.role!=="admin")return;const a=O.find(o=>o.id===e);a&&M("Excluir Usuário?",`Tem a certeza de que deseja excluir o usuário "${a.username}"?`,()=>{const o=O.findIndex(r=>r.id===e);o>-1&&O.splice(o,1),J(),Q(),d("Usuário excluído!","danger")})}window.deleteUser=bt;function _e(){const e=document.getElementById("operations-history-list");if(e){if(e.innerHTML="",I.length===0){e.innerHTML=`<div class="text-center py-8 bg-white rounded-lg border border-gray-200">
            <i class="fas fa-history text-4xl text-gray-300 mb-3"></i>
            <p class="text-secondary">Nenhuma operação realizada ainda.</p>
        </div>`;return}I.slice().reverse().forEach(t=>{const n=new Date(t.date),a=t.invoiceNumber||t.id,o=a.startsWith("OP-")?a:`OP: ${a}`,r=document.createElement("div");r.className="bg-white p-4 rounded-lg border border-gray-200 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center",r.innerHTML=`
            <div class="flex-grow mb-4 sm:mb-0">
                <p class="font-bold text-primary-DEFAULT">${o}</p>
                <p class="text-sm text-secondary">Data: ${n.toLocaleDateString("pt-BR")} às ${n.toLocaleTimeString("pt-BR")}</p>
                <p class="text-sm text-secondary">Total de Itens: ${t.items.length}</p>
            </div>
            <div class="flex space-x-2 flex-shrink-0">
                <button data-op-id="${t.id}" class="btn-icon-secondary view-invoice-btn" title="Ver Invoice"><i class="fas fa-file-invoice-dollar"></i></button>
                <button data-op-id="${t.id}" class="btn-icon-secondary view-packlist-btn" title="Ver Packing List"><i class="fas fa-box-open"></i></button>
                <button data-op-id="${t.id}" class="btn-icon-danger delete-op-btn" title="Excluir Operação"><i class="fas fa-trash"></i></button>
            </div>
        `,e.appendChild(r)}),document.querySelectorAll("#operations-history-list .view-invoice-btn").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.dataset.opId,o=I.find(r=>r.id===a);o&&(sessionStorage.setItem("invoiceData",JSON.stringify({operation:o,allSuppliers:v,allItems:u})),window.open("gerenciador_invoice.html","_blank"))})}),document.querySelectorAll("#operations-history-list .view-packlist-btn").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.dataset.opId,o=I.find(r=>r.id===a);o&&(sessionStorage.setItem("packlistData",JSON.stringify({operation:o,allSuppliers:v,allItems:u})),window.open("gerador_packing_list.html","_blank"))})}),document.querySelectorAll("#operations-history-list .delete-op-btn").forEach(t=>{t.addEventListener("click",n=>{const a=n.currentTarget.dataset.opId;M("Excluir Operação?",`Tem a certeza que deseja excluir a operação ${a}?`,()=>{const o=I.findIndex(r=>r.id===a);o>-1&&I.splice(o,1),_e(),d("Operação excluída com sucesso!","danger")})})})}}function X(e){document.querySelectorAll(".main-view").forEach(i=>{i.classList.add("hidden")});const t=document.getElementById(`view-${e}`);t&&t.classList.remove("hidden"),history.pushState("",document.title,window.location.pathname+window.location.search);const n=document.getElementById("header-title"),a={dashboard:"Dashboard",operations:"Central de Operações",reports:"Relatórios",menu:"Menu"};n.textContent=a[e]||"StockControl Pro",document.querySelectorAll(".nav-item").forEach(i=>i.classList.remove("active"));const o=document.getElementById(`nav-${e}`);o&&o.classList.add("active"),document.querySelectorAll(".top-nav .nav-link").forEach(i=>i.classList.remove("active"));const r=document.getElementById(`desktop-nav-${e}`);r&&r.classList.add("active")}function de(){const e=document.getElementById("operations-history-list-container");if(e)if(e.innerHTML="",I.length===0)e.innerHTML=`<div style="text-align: center; padding: 2rem;">
            <i data-feather="clock" style="width: 48px; height: 48px; margin: 0 auto 1rem; color: var(--text-secondary);"></i>
            <p class="text-secondary">Nenhuma operação realizada ainda.</p>
        </div>`,feather.replace();else{const t=document.createElement("div");t.className="history-list",I.slice().reverse().forEach(n=>{const a=new Date(n.date),o=n.type==="import"?'<span class="badge import">Importada</span>':'<span class="badge manual">Manual</span>',r=n.invoiceNumber||n.id,i=r.startsWith("OP-")?r:`OP: ${r}`,c=document.createElement("div");c.className="history-card",c.innerHTML=`
                <div class="history-card-details">
                    <div class="history-card-header">
                        <p class="history-id">${i}</p>
                        ${o}
                    </div>
                    <p class="history-meta">Data: ${a.toLocaleDateString("pt-BR")} às ${a.toLocaleTimeString("pt-BR")}</p>
                    <p class="history-meta">Total de Itens: ${n.nfeData?n.nfeData.reduce((s,l)=>s+l.produtos.length,0):n.items.length}</p>
                </div>
                <div class="history-card-actions">
                    <button data-op-id="${n.id}" class="btn btn-secondary view-invoice-btn" title="Ver Invoice"><i data-feather="file-text"></i></button>
                    <button data-op-id="${n.id}" class="btn btn-secondary view-packlist-btn" title="Ver Packing List"><i data-feather="package"></i></button>
                    <button data-op-id="${n.id}" class="btn btn-danger delete-op-btn" title="Excluir Operação"><i data-feather="trash-2"></i></button>
                </div>
            `,t.appendChild(c)}),e.appendChild(t),e.querySelectorAll(".view-invoice-btn").forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.opId,r=I.find(i=>i.id===o);r&&(localStorage.setItem("currentDocument",JSON.stringify({operation:r,allSuppliers:v,allItems:u})),window.open("gerenciador_invoice.html","_self"))})}),e.querySelectorAll(".view-packlist-btn").forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.opId,r=I.find(i=>i.id===o);r&&(localStorage.setItem("currentDocument",JSON.stringify({operation:r,allSuppliers:v,allItems:u})),window.open("gerador_packing_list.html","_self"))})}),e.querySelectorAll(".delete-op-btn").forEach(n=>{n.addEventListener("click",a=>{const o=a.currentTarget.dataset.opId;Oe(o)})}),feather.replace()}}function K(){de(),B("operations-history-modal")}function Oe(e){M("Excluir Operação?",`Tem a certeza que deseja excluir a operação ${e}? Esta ação não pode ser desfeita.`,()=>{const t=I.findIndex(o=>o.id===e);if(t===-1){d("Erro: Operação não encontrada para excluir.","danger");return}I[t].items.forEach(o=>{const r=u.findIndex(i=>i.id===o.id);r>-1&&(u[r].quantity+=Number(o.operationQuantity||0))});const a=k.map((o,r)=>o.operationId===e?r:-1).filter(o=>o!==-1);for(let o=a.length-1;o>=0;o--)k.splice(a[o],1);I.splice(t,1),P(),d(`Operação ${e} excluída com sucesso!`,"danger"),de()})}window.deleteOperation=Oe;let A={};function De(){if(!_("reports")){d("Não tem permissão para ver relatórios.","danger");return}B("reports-modal");const e=document.querySelector('#reports-tab-nav .report-tab[data-tab="overview"]');e&&Pe(e,"overview")}function Pe(e,t){if(document.querySelectorAll(".report-tab").forEach(n=>n.classList.remove("active")),e.classList.add("active"),document.querySelectorAll(".report-tab-content").forEach(n=>n.classList.remove("active")),document.getElementById(`tab-${t}`).classList.add("active"),t==="overview")Bt();else if(t==="products")Te();else if(t==="history"){const n=document.getElementById("daily-movements-date-picker");n.value||(n.value=new Date().toISOString().split("T")[0]),Me()}}function Bt(){A.valueChart&&A.valueChart.destroy(),A.statusChart&&A.statusChart.destroy();const e=u.reduce((o,r)=>{const i=r.quantity*r.costPrice;return o["Valor Total em Stock"]=(o["Valor Total em Stock"]||0)+i,o},{}),t=document.getElementById("valueChart").getContext("2d");A.valueChart=new Chart(t,{type:"doughnut",data:{labels:Object.keys(e),datasets:[{data:Object.values(e),backgroundColor:["#FACC15","#374151","#9CA3AF"]}]},options:{responsive:!0,maintainAspectRatio:!1}});const n=u.reduce((o,r)=>{const i=ee(r).text;return o[i]=(o[i]||0)+1,o},{OK:0,Baixo:0,Crítico:0,Esgotado:0}),a=document.getElementById("statusChart").getContext("2d");A.statusChart=new Chart(a,{type:"bar",data:{labels:Object.keys(n),datasets:[{label:"Nº de Itens",data:Object.values(n),backgroundColor:["#22C55E","#F97316","#EF4444","#6B7280"]}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y"}}),kt()}function kt(){const e=document.getElementById("reports-movements-history");e.innerHTML="";const t=[...k].sort((n,a)=>new Date(a.date)-new Date(n.date)).slice(0,10);if(t.length===0){e.innerHTML='<p class="text-secondary text-center py-4">Nenhuma movimentação registada.</p>';return}t.forEach(n=>{const a=u.find(r=>r.id===n.itemId),o=document.createElement("div");o.className=`report-movement-item ${n.type}`,o.innerHTML=`
            <div class="movement-info">
                <span class="movement-name">${a?S(a.name):"Item Excluído"}</span>
                <span class="movement-qty">(${n.quantity} un.)</span>
                ${n.operationId?`<span class="movement-op">(${S(n.operationId)})</span>`:""}
            </div>
            <span class="movement-date">${new Date(n.date).toLocaleString("pt-BR")}</span>
        `,e.appendChild(o)})}function Te(){const e=document.getElementById("reports-period-filter").value,t=new Date,n=new Date;e!=="all"&&n.setDate(t.getDate()-parseInt(e));const o=(e==="all"?k.filter(s=>s.type==="out"):k.filter(s=>s.type==="out"&&new Date(s.date)>=n)).reduce((s,l)=>(s[l.itemId]=(s[l.itemId]||0)+l.quantity,s),{}),r=Object.entries(o).sort(([,s],[,l])=>l-s).slice(0,5),i=Object.entries(o).sort(([,s],[,l])=>s-l).slice(0,5),c=(s,l)=>{const p=u.find(E=>E.id===s);if(!p||!p.unitsPerPackage)return`${l} un.`;const m=Math.floor(l/p.unitsPerPackage),g=p.packageType==="fardo"?m>1?"fardos":"fardo":m>1?"caixas":"caixa";return`${m} ${g}`};ge("top-selling-items",r,"embalagens vendidas",c),ge("least-selling-items",i,"embalagens vendidas",c)}function ge(e,t,n,a){const o=document.getElementById(e);if(o.innerHTML="",t.length===0){o.innerHTML='<p class="text-secondary text-center py-4">Nenhum dado para o período selecionado.</p>';return}const r=t.length>0?t[0][1]:0;t.forEach(([i,c])=>{const s=u.find(g=>g.id===i);if(!s)return;const l=r>0?c/r*100:0,p=a(i,c),m=document.createElement("div");m.className="ranking-item",m.innerHTML=`
            <div class="ranking-header">
                <span class="ranking-name">${S(s.name)}</span>
                <span class="ranking-value">${p}</span>
            </div>
            <div class="ranking-bar-background">
                <div class="ranking-bar-foreground" style="width: ${l}%"></div>
            </div>
        `,o.appendChild(m)})}function Me(){const e=document.getElementById("daily-movements-list"),t=document.getElementById("daily-movements-date-picker"),n=new Date(t.value+"T00:00:00");e.innerHTML="";const a=new Date(n.setHours(0,0,0,0)),o=new Date(n.setHours(23,59,59,999)),r=k.filter(i=>{const c=new Date(i.date);return c>=a&&c<=o}).sort((i,c)=>new Date(c.date)-new Date(i.date));if(r.length===0){e.innerHTML=`<div class="panel-empty-state">
            <i data-feather="calendar"></i>
            <p>Nenhuma movimentação para esta data.</p>
        </div>`,feather.replace();return}r.forEach(i=>{const c=u.find(g=>g.id===i.itemId),s=c?v.find(g=>g.id===c.supplierId):null,l=i.type==="out",p=l?"-":"+",m=document.createElement("div");m.className=`daily-movement-card ${i.type}`,m.innerHTML=`
            <div class="movement-icon"><i data-feather="${l?"arrow-up-circle":"arrow-down-circle"}"></i></div>
            <div class="movement-details">
                <div class="movement-header">
                    <span class="movement-name">${c?S(c.name):"Item Excluído"}</span>
                    <span class="movement-time">${new Date(i.date).toLocaleTimeString("pt-BR")}</span>
                </div>
                <p class="movement-reason">${S(i.reason||"N/A")}</p>
                <div class="movement-stats">
                    <div><strong>Qtd:</strong> ${p}${i.quantity} un.</div>
                    <div><strong>Valor:</strong> ${T(i.price,"BRL")}</div>
                    <div><strong>Total:</strong> ${T(i.price*i.quantity,"BRL")}</div>
                    <div><strong>Fornecedor:</strong> ${s?S(s.name):"N/A"}</div>
                </div>
            </div>
        `,e.appendChild(m)}),feather.replace()}let $={id:null,items:[],isEditing:!1};function Ce(){const e=document.getElementById("operation-available-items");e.innerHTML="";const t=u.filter(n=>n.quantity>0);if(t.length===0){e.innerHTML='<p class="text-secondary text-center">Nenhum item com stock disponível.</p>';return}t.forEach(n=>{const a=$.items.some(l=>l.id===n.id),o=document.createElement("div");o.className=`op-item-card available ${a?"added":""}`;const r=n.unitsPerPackage>0?Math.floor(n.quantity/n.unitsPerPackage):0,i=n.packageType==="fardo"?r===1?"fardo":"fardos":r===1?"caixa":"caixas",c=`${r} ${i}`,s=n.packageType==="fardo"?"Fardos":"Caixas";o.innerHTML=`
            <div class="op-item-info">
                <p class="op-item-name">${S(n.name)}</p>
                <p class="op-item-stock">Em stock: ${c}</p>
            </div>
            <div class="op-item-actions">
                <div class="input-group">
                    <label>Qtd. (${s})</label>
                    <input type="number" id="op-qty-box-${n.id}" class="form-input" min="1" max="${r}">
                </div>
                <div class="input-group">
                    <label>Preço Venda</label>
                    <input type="number" id="op-price-${n.id}" class="form-input" step="0.01" value="${n.salePrice}">
                </div>
                <button onclick="addItemToOperation('${n.id}')" class="btn btn-add-op" id="add-op-btn-${n.id}">Adicionar</button>
            </div>
        `,e.appendChild(o)}),feather.replace()}function xt(e){const t={...u.find(c=>c.id===e)},n=document.getElementById(`op-qty-box-${e}`),a=document.getElementById(`op-price-${e}`),o=parseInt(n.value),r=parseFloat(a.value);if(!o||o<=0){d("Por favor, insira uma quantidade válida.","warning");return}const i=o*(t.unitsPerPackage||1);if(i>t.quantity){d("A quantidade de saída não pode ser maior que o stock disponível.","warning");return}$.items.push({...t,operationQuantity:i,operationPrice:r}),Ae(),Ce(),Ne()}window.addItemToOperation=xt;function Ae(){const e=document.getElementById("operation-selected-items");if(e.innerHTML="",$.items.length===0){e.innerHTML='<div class="panel-empty-state"><p>Nenhum item adicionado.</p></div>';return}$.items.forEach(t=>{const n=document.createElement("div");n.className="op-item-card selected";const a=t.unitsPerPackage>0?Math.floor(t.operationQuantity/t.unitsPerPackage):0,o=t.packageType==="fardo"?a===1?"fardo":"fardos":a===1?"caixa":"caixas",r=`${a} ${o}`;n.innerHTML=`
            <div class="op-item-info">
                <p class="op-item-name">${S(t.name)}</p>
                <p class="op-item-stock">A sair: ${r} @ ${T(t.operationPrice,"BRL")}</p>
            </div>
            <button onclick="removeItemFromOperation('${t.id}')" class="btn-remove-op">
                <i data-feather="x"></i>
            </button>
        `,e.appendChild(n)}),feather.replace()}function St(e){$.items=$.items.filter(t=>t.id!==e),Ae(),Ce(),Ne()}window.removeItemFromOperation=St;function Ne(){const e=document.getElementById("operation-summary");if($.items.length===0){e.innerHTML="";return}let t=0,n=0,a=0;$.items.forEach(r=>{const i=r.unitsPerPackage>0?Math.floor(r.operationQuantity/r.unitsPerPackage):0;t+=i;let c=r.operationQuantity*(r.unitMeasureValue||0);(r.unitMeasureType==="g"||r.unitMeasureType==="ml")&&(c/=1e3),n+=c,a+=r.operationQuantity*r.operationPrice});const o=n*1.035;e.innerHTML=`
        <div class="summary-row">
            <span>Total de Embalagens:</span>
            <span class="summary-value">${t}</span>
        </div>
        <div class="summary-row">
            <span>Peso Líquido Total (est.):</span>
            <span class="summary-value">${n.toFixed(2)} kg</span>
        </div>
        <div class="summary-row">
            <span>Peso Bruto Total (est.):</span>
            <span class="summary-value">${o.toFixed(2)} kg</span>
        </div>
        <div class="summary-total">
            <span>Valor Total:</span>
            <span class="summary-value total">${T(a,"BRL")}</span>
        </div>
    `}async function $t(){if($.items.length===0){d("Adicione pelo menos um item à operação antes de finalizar.","warning");return}const e=L();if(!e){d("Usuário não autenticado. Não é possível salvar a operação.","danger");return}const t={...$,user_id:e.id,items:JSON.parse(JSON.stringify($.items)),type:"manual"};try{await se(t),I.push(t),d(`Operação ${t.id} criada e salva com sucesso!`,"success"),$.items.forEach(n=>{const a=u.findIndex(r=>r.id===n.id);a>-1&&(u[a].quantity-=n.operationQuantity);const o={id:`mov_${Date.now()}_${n.id}`,itemId:n.id,type:"out",quantity:n.operationQuantity,price:n.operationPrice,reason:"Saída por Operação",operationId:$.id,date:$.date};k.push(o)}),w("operation-modal"),P(),document.dispatchEvent(new CustomEvent("operation-saved"))}catch(n){d(`Erro ao salvar operação manual: ${n.message}`,"danger"),console.error("Falha ao salvar operação manual:",n)}}function le(e,t){const n=I.find(o=>o.id===e);if(!n){d("Operação não encontrada no histórico.","danger");return}const a={operation:n,allSuppliers:v};t==="invoice"?(localStorage.setItem("currentDocument",JSON.stringify(a)),window.open("gerenciador_invoice.html","_self")):t==="packlist"&&(localStorage.setItem("currentDocument",JSON.stringify(a)),window.open("gerador_packing_list.html","_self"))}window.regenerateDocument=le;async function Lt(e,t){for(const n of e){const{fornecedor:a,produtos:o,notaFiscal:r}=n;try{const i=a.cnpj?V(a.cnpj):"";let c=i?v.find(s=>V(s.cnpj)===i):null;if(!c){const s=L();if(!s){d("Erro: Usuário não autenticado para criar fornecedor.","danger");continue}const l={name:a.nome,cnpj:a.cnpj,address:a.address||"",user_id:s.id};c=await be(l),v.push(c),d(`Novo fornecedor "${c.name}" salvo.`,"info")}for(const s of o){let l=u.find(D=>D.code===s.code&&D.supplier_id===c.id);if(!l){const D=L();if(!D){d("Erro: Usuário não autenticado.","danger");continue}const j={user_id:D.id,name:s.name,code:s.code,ncm:s.ncm,description:`Importado via NF-e ${r.numero}`,quantity:0,min_quantity:0,cost_price:s.costPrice,sale_price:s.costPrice*1.25,supplier_id:c.id};l=await ie(j),u.push(l),d(`Novo item "${l.name}" salvo.`,"info")}const p=l.id,m=L();if(!m){d("Erro: Usuário não autenticado para criar movimentação.","danger");continue}const g={user_id:m.id,item_id:p,type:"in",quantity:s.quantity,price:s.costPrice,reason:`Entrada via NF-e: ${r.numero}`,operation_id:t,date:new Date().toISOString()},E=await Z(g);k.push(E),s.item_id=p;const x={user_id:m.id,item_id:p,type:"out",quantity:s.quantity,price:s.costPrice,reason:`Saída para Exportação (Op: ${t})`,operation_id:t,date:new Date().toISOString()},h=await Z(x);k.push(h)}}catch(i){d(`Erro ao processar NF-e: ${i.message}`,"danger"),console.error("Erro em finalizarOperacaoDeImportacao:",i)}}d("Movimentações da NF-e foram registradas no banco de dados.","success"),P()}async function _t(e){const t=b.findIndex(r=>r.id===e);if(t===-1){d("Ordem de compra não encontrada.","danger");return}const n=L();if(!n){d("Usuário não autenticado. Não é possível salvar a operação.","danger");return}const a=b[t];if(a.status!=="pending_stock_entry"){d(`A ordem de compra ${e} não está pronta para entrada no estoque.`,"warning");return}a.items.forEach(r=>{const i=u.findIndex(c=>c.id===r.id);if(i>-1){u[i].quantity+=r.operationQuantity,u[i].costPrice=r.costPrice,u[i].updatedAt=new Date().toISOString();const c={id:`mov_in_${Date.now()}_${r.id}`,itemId:r.id,type:"in",quantity:r.operationQuantity,price:r.costPrice,reason:`Entrada via OC ${a.id}`,date:new Date().toISOString()};k.push(c)}});const o=a;o.user_id=n.id,o.purchaseOrderId=o.id,o.id=o.id.replace("OC-","OP-"),o.type="manual",o.status="completed",o.date=new Date().toISOString(),delete o.xml_attached,o.items.forEach(r=>{const i=u.findIndex(s=>s.id===r.id);i>-1&&(u[i].quantity-=r.operationQuantity);const c={id:`mov_out_${Date.now()}_${r.id}`,itemId:r.id,type:"out",quantity:r.operationQuantity,price:r.operationPrice,reason:`Saída por Operação de OC ${o.purchaseOrderId}`,operationId:o.id,date:o.date};k.push(c)});try{await se(o),d(`Ordem de Compra ${o.purchaseOrderId} processada. Operação de Saída ${o.id} criada e salva.`,"success"),await dt(e),I.push(o),b.splice(t,1),le(o.id,"invoice")}catch(r){d(`Erro ao salvar operação da Ordem de Compra: ${r.message}`,"danger"),console.error("Falha ao salvar operação da OC:",r)}}const ue="stock_simulation_draft";let f={};function q(e){document.getElementById("sim-preview-invoice-btn").disabled=!e,document.getElementById("sim-save-draft-btn").disabled=!e,document.getElementById("sim-finalize-btn").disabled=!e}function ye(){const e=localStorage.getItem(ue);e?M("Continuar simulação?","Encontramos uma simulação não finalizada. Deseja continuar de onde parou?",()=>{f=JSON.parse(e),document.getElementById("simulation-id").innerText=`ID: ${f.id}`,C(),z(),Y(),B("simulation-modal"),q(!0)}):(Ot(),q(!0))}function Ot(){f={id:`SIM-${Date.now()}`,items:[],status:"draft"},document.getElementById("simulation-id").innerText=`ID: ${f.id}`,C(),z(),Y(),B("simulation-modal")}function qe(){localStorage.setItem(ue,JSON.stringify(f))}function Ue(){localStorage.removeItem(ue)}function Y(){const e=document.getElementById("sim-summary");if(f.items.length===0){e.innerHTML="";return}let t=0,n=0;f.items.forEach(a=>{t+=a.operationQuantity,n+=a.operationQuantity*(a.costPrice||0)}),e.innerHTML=`
        <div class="summary-row">
            <span>Total de Itens:</span>
            <span class="summary-value">${t}</span>
        </div>
        <div class="summary-row">
            <span>Custo Total (est.):</span>
            <span class="summary-value">R$ ${n.toFixed(2)}</span>
        </div>
    `}function z(){const e=document.getElementById("sim-selected-items");if(e.innerHTML="",!f||!f.items||f.items.length===0){e.innerHTML='<div class="panel-empty-state"><p>Nenhum item adicionado à simulação.</p></div>';return}f.items.forEach(t=>{const n=document.createElement("div");n.className="op-item-card selected",n.innerHTML=`
            <div class="op-item-info">
                <p class="op-item-name">${t.name}</p>
                <p class="op-item-stock">Qtd: ${t.operationQuantity} @ ${t.operationPrice.toFixed(2)}</p>
            </div>
        `;const a=document.createElement("button");a.className="btn-remove-op",a.dataset.itemId=t.id,a.innerHTML='<i data-feather="x"></i>',a.addEventListener("click",o=>{Fe(o.currentTarget.dataset.itemId)}),n.appendChild(a),e.appendChild(n)}),feather.replace(),Y()}function Fe(e){f.items=f.items.filter(t=>t.id!==e),d("Item removido da simulação.","info"),z(),C(),qe()}window.removeItemFromSimulation=Fe;function C(){const e=document.getElementById("sim-available-items");e.innerHTML="";const t=document.getElementById("sim-search-input").value.toLowerCase(),n=u.filter(a=>{const o=a.name?a.name.toLowerCase().includes(t):!1,r=a.code?a.code.toLowerCase().includes(t):!1,i=a.ncm?a.ncm.toLowerCase().includes(t):!1;return o||r||i});if(n.length===0){e.innerHTML='<p class="text-secondary text-center">Nenhum item encontrado.</p>';return}n.forEach(a=>{const o=Array.isArray(f.items)&&f.items.some(s=>s.id===a.id),r=document.createElement("div");r.className=`op-item-card available ${o?"added":""}`;const i=v.find(s=>s.id===a.supplierId),c=i?i.name:"Fornecedor Desconhecido";r.innerHTML=`
            <div class="op-item-info">
                <p class="op-item-name">${a.name}</p>
                <p class="op-item-stock">Cód: ${a.code} | Forn: ${c}</p>
            </div>
            <div class="op-item-actions">
                        <div class="input-group" style="display: none;">
                            <label>Qtd.</label>
                            <input type="number" id="sim-qty-${a.id}" class="form-input" min="1" value="1">
                        </div>                <button class="btn btn-add-op" id="add-sim-btn-${a.id}" data-item-id="${a.id}">Adicionar</button>
            </div>
        `,e.appendChild(r),r.querySelector(`#add-sim-btn-${a.id}`).addEventListener("click",s=>{Re(s.currentTarget.dataset.itemId)})})}function Dt(e,t,n){if(!(e.unitMeasureValue>0&&e.unitsPerPackage>0&&e.unitMeasureType!=="un")){const o=e.name.match(/(\d+)\s*[xX]\s*(\d+(?:[.,]\d+)?)(?:[^\d\w]*)(G|GR|KG|L|ML)?/i);if(o)e.unitsPerPackage=parseInt(o[1],10),e.unitMeasureValue=parseFloat(o[2].replace(",",".")),e.unitMeasureType=(o[3]||"").toLowerCase();else{const r=e.name.match(/(\d+(?:[.,]\d+)?)(?:[^\d\w]*)(G|GR|KG|L|ML)/i);r&&(e.unitsPerPackage=1,e.unitMeasureValue=parseFloat(r[1].replace(",",".")),e.unitMeasureType=(r[2]||"").toLowerCase())}}e.unitMeasureType==="gr"&&(e.unitMeasureType="g");let a="";return e.unitsPerPackage>0&&e.unitMeasureValue>0?a=`${e.unitsPerPackage}X${e.unitMeasureValue}${e.unitMeasureType.toUpperCase()}`:e.unitMeasureValue>0&&(a=`${e.unitMeasureValue}${e.unitMeasureType.toUpperCase()}`),a}function Re(e){Array.isArray(f.items)||(f.items=[]);const t={...u.find(r=>r.id===e)};v.find(r=>r.id===t.supplierId);const n=Dt(t),a=1,o=f.items.find(r=>r.id===e);o?(o.operationQuantity=a,d(`Quantidade de ${t.name} atualizada para ${a}.`,"info")):(f.items.push({...t,operationQuantity:a,operationPrice:t.salePrice||t.costPrice||0,qtyUnit:n}),d(`${t.name} adicionado à simulação.`,"success")),f.items.length>0&&q(!0),z(),C(),qe()}window.addItemToSimulation=Re;window.renderSimulationAvailableItems=C;function Pt(){const e=document.getElementById("simItemSupplier");e.innerHTML="",v.forEach(n=>{const a=document.createElement("option");a.value=n.id,a.innerText=n.name,e.appendChild(a)});const t=n=>{n.target.value=n.target.value.replace(/\D/g,"")};document.getElementById("simItemCode").oninput=t,document.getElementById("simItemNcm").oninput=t,document.getElementById("sim-item-form").onsubmit=Tt,B("sim-add-item-modal")}async function Tt(e){e.preventDefault();const t=L();if(!t){d("Usuário não autenticado. Não é possível salvar o item.","danger");return}const n=document.getElementById("simItemName").value,a=document.getElementById("simItemNameEn").value,o=document.getElementById("simItemCode").value,r=document.getElementById("simItemNcm").value,i=document.getElementById("simItemDescription").value,c=parseFloat(document.getElementById("simItemCostPrice").value),s=document.getElementById("simItemSupplier").value,l=parseInt(document.getElementById("simUnitsPerPackage").value)||1,p=parseFloat(document.getElementById("simUnitMeasureValue").value)||1,m=document.getElementById("simUnitMeasureType").value,g=[{check:n,message:'O campo "Nome do Item" é obrigatório.'},{check:o,message:'O campo "Código/SKU" é obrigatório.'},{check:!isNaN(c)&&c>0,message:'O "Preço de Custo" deve ser um número maior que zero.'},{check:s,message:'O campo "Fornecedor" é obrigatório.'},{check:!r||r.length===8,message:"O NCM, se preenchido, deve conter exatamente 8 dígitos."}];for(const h of g)if(!h.check){d(h.message,"warning");return}if(u.some(h=>h.code===o&&h.supplierId===s)){d("Um item com este Código/SKU e Fornecedor já existe no estoque.","danger");return}const x={user_id:t.id,name:n,nameEn:a,code:o,ncm:r,description:i||`Item ${n} adicionado via simulação.`,costPrice:c,salePrice:c*1.25,supplierId:s,quantity:0,minQuantity:0,unitsPerPackage:l,packageType:l>1?"caixa":"unidade",unitMeasureValue:p,unitMeasureType:m,image:null,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};try{const h=await ie(x);u.push(h),d(`Novo item "${n}" foi adicionado ao estoque!`,"success")}catch(h){d(`Erro ao salvar novo item: ${h.message}`,"danger"),console.error("Erro ao salvar novo item:",h);return}w("sim-add-item-modal"),document.getElementById("sim-item-form").reset(),C()}function Mt(e){f=e,document.getElementById("simulation-id").innerText=`ID: ${f.id}`,C(),z(),Y(),B("simulation-modal"),q(!0)}function Ct(){if(!f||!f.items||f.items.length===0){d("Adicione itens à simulação antes de pré-visualizar o Invoice.","warning");return}sessionStorage.setItem("simulationReturnData",JSON.stringify(f));const e={operation:{id:f.id,date:new Date().toISOString(),items:f.items,type:"simulation_preview"},allSuppliers:v};localStorage.setItem("currentDocument",JSON.stringify(e)),window.open("gerenciador_invoice.html?origin=simulation","_self")}function At(){if(f.items.length===0){d("Adicione itens à simulação antes de salvar como rascunho.","warning");return}f.status="pending",Ue(),w("simulation-modal"),d(`Simulação ${f.id} salva como rascunho.`,"success"),q(!1)}async function Nt(){if(!f||!f.items||f.items.length===0){d("Adicione itens à simulação antes de criar uma Ordem de Compra.","warning");return}const e=L();if(!e){d("Usuário não autenticado. Não é possível criar a Ordem de Compra.","danger");return}const t={id:f.id.replace("SIM","OC"),user_id:e.id,date:new Date().toISOString(),items:f.items,type:"purchase_order",status:"pending_xml"};try{const n=await ct(t);b.push(n),d(`Ordem de Compra ${n.id} criada com sucesso!`,"success")}catch(n){d(`Erro ao criar Ordem de Compra: ${n.message}`,"danger"),console.error("Erro ao criar Ordem de Compra:",n);return}Ue(),w("simulation-modal"),q(!1)}async function qt(e,t,n,a){const o=new FormData;o.append("file",e);try{const r=await fetch("/api/upload/",{method:"POST",headers:{Authorization:"secret"},body:o});if(!r.ok){const h=await r.json();throw new Error(h.detail||"Erro ao processar o XML no backend.")}const i=await r.json(),c=b.findIndex(h=>h.id===t);if(c===-1)throw new Error("Ordem de compra não encontrada.");const s=b[c],l=i.produtos,p=i.fornecedor.cnpj,m=v.find(h=>h.cnpj===p);if(!m)throw new Error(`Fornecedor com CNPJ ${p} não encontrado no sistema.`);const g=[];let E=0;l.forEach(h=>{const D=s.items.find(j=>{const He=String(j.code).trim()===String(h.code).trim(),Ve=j.supplier_id===m.id;return He&&Ve});D?(D.costPrice=h.costPrice,D.operationPrice=h.costPrice,E++):g.push(`${h.name} (Cód: ${h.code})`)}),b[c]=s;let x=`Preços de ${E} item(ns) atualizados na OC ${t} a partir do arquivo ${e.name}.`;g.length>0?(x+=`

Os seguintes produtos do XML não foram encontrados na OC:
- ${g.join(`
- `)}`,d(x,"warning",1e4)):d(x,"success"),await Be(t,{items:s.items,xml_attached:!0}),n&&typeof n=="function"&&n()}catch(r){console.error("Erro ao processar a Ordem de Compra:",r),d(r.message,"danger"),a&&typeof a=="function"&&a(r)}}function ae(){ze(),B("purchase-orders-modal")}function ze(){const e=document.getElementById("purchase-orders-list-container");let t=b.filter(n=>n.status!=="completed");if(t.sort((n,a)=>new Date(a.date)-new Date(n.date)),t.length===0){e.innerHTML='<div class="panel-empty-state"><p>Nenhuma ordem de compra pendente.</p></div>';return}e.innerHTML=t.map(n=>{let a="",o="";return n.status==="pending_xml"?(o='<span class="badge status-pending">Aguardando XML</span>',a=`
                <div class="po-button-group">
                    <button class="btn btn-secondary btn-sm" onclick="window.viewPurchaseOrder('${n.id}')">Visualizar/Editar</button>
                    <button class="btn btn-secondary btn-sm" onclick="window.attachXml('${n.id}')">Anexar XML</button>
                    <button class="btn btn-success btn-sm" onclick="window.finalizeAttachments('${n.id}')">Finalizar Anexos</button>
                </div>
            `):n.status==="pending_stock_entry"&&(o='<span class="badge status-ready">Pronto para Entrada</span>',a=`<button class="btn btn-primary btn-sm" onclick="window.stockIn('${n.id}')">Dar Entrada no Estoque</button>`),`
        <div class="po-item-card">
            <div class="po-item-info">
                <p class="po-item-id">ID: ${n.id}</p>
                <p class="po-item-date">Data: ${new Date(n.date).toLocaleDateString("pt-BR")}</p>
                <p class="po-item-status">Status: ${o}</p>
            </div>
            <div class="po-item-actions">
                ${a}
            </div>
        </div>
    `}).join("")}window.attachXml=e=>{const t=b.find(a=>a.id===e);if(!t){d("Erro crítico: Ordem de compra não encontrada para verificação.","danger");return}for(const a of t.items)if(!a.code||!a.supplier_id){const o=`Erro de Integridade de Dados na OC ${e}: O item "${a.name}" (ID: ${a.id}) está sem 'código' ou 'ID do fornecedor'. Os dados podem ter sido perdidos durante a criação ou edição da OC.`;d(o,"danger",1e4),console.error(o,"Item data:",a);return}const n=document.getElementById("po-xml-upload");n.setAttribute("data-order-id",e),n.click()};window.finalizeAttachments=async e=>{const t=b.findIndex(a=>a.id===e);if(t===-1){d("Ordem de compra não encontrada.","danger");return}if(!b[t].xml_attached){d("É necessário anexar e processar um arquivo XML antes de finalizar.","warning");return}const n="pending_stock_entry";try{await Be(e,{status:n}),b[t].status=n,ze(),d("Ordem de Compra finalizada. Pronta para entrada no estoque.","success")}catch(a){d(`Erro ao atualizar status da Ordem de Compra: ${a.message}`,"danger"),console.error("Erro ao finalizar anexos:",a)}};window.stockIn=e=>{_t(e)};async function Ut(e){const t=e.target.files,n=e.target.getAttribute("data-order-id"),a=e.target;if(!t.length||!n)return;if(!b.find(i=>i.id===n)){d("Ordem de compra não encontrada.","danger");return}const r=Array.from(t).map(i=>new Promise((c,s)=>{qt(i,n,c,s)}));try{await Promise.all(r),await ce(),d("Dados da Ordem de Compra atualizados com sucesso!","success")}catch(i){console.error("Ocorreu um erro durante o processamento dos XMLs:",i),d("Ocorreu um erro durante o processamento de um ou mais XMLs.","danger")}finally{a.value=null,a.removeAttribute("data-order-id")}}window.viewPurchaseOrder=e=>{const t=b.find(a=>a.id===e);if(!t){d("Ordem de compra não encontrada.","danger");return}const n={operation:t,allSuppliers:v};localStorage.setItem("currentDocument",JSON.stringify(n)),window.open("gerenciador_invoice.html?origin=purchase-orders","_self")};document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("po-xml-upload");e&&e.addEventListener("change",Ut)});function Ft(){const e=(i,c)=>{const s=document.getElementById(i);s&&s.addEventListener("click",c)},t=(i,c)=>{const s=document.getElementById(i);s&&s.addEventListener("change",c)},n=(i,c)=>{const s=document.getElementById(i);s&&s.addEventListener("keyup",c)};e("add-item-btn-header",te),e("menu-suppliers",pe),e("menu-users",fe),e("menu-packlist",()=>window.open("gerador_packing_list.html","_self")),e("menu-invoice",()=>window.open("gerenciador_invoice.html","_self")),e("menu-purchase-orders",ae),e("logout-btn-menu",U),e("desktop-add-item-btn",te),e("desktop-suppliers-btn",pe),e("desktop-users-btn",fe),e("desktop-logout-btn",U),e("desktop-reports-btn",De),e("desktop-nav-purchase-orders",ae),e("nav-operations",()=>B("operations-hub-modal"));const a=document.getElementById("desktop-nav-operations"),o=document.getElementById("operations-dropdown");a&&o&&(a.addEventListener("click",i=>{i.preventDefault();const c=o.classList.toggle("hidden");a.classList.toggle("open",!c)}),document.addEventListener("click",i=>{!a.contains(i.target)&&!o.contains(i.target)&&(o.classList.add("hidden"),a.classList.remove("open"))}));const r=()=>{o&&(o.classList.add("hidden"),a.classList.remove("open"))};e("dropdown-import-op-btn",()=>{r(),document.getElementById("xml-upload-main").click()}),e("dropdown-simulate-op-btn",()=>{r(),ye()}),e("dropdown-history-op-btn",()=>{r(),K()}),e("hub-import-op-btn",()=>{w("operations-hub-modal"),document.getElementById("xml-upload-main").click()}),e("hub-simulate-op-btn",()=>{w("operations-hub-modal"),ye()}),e("hub-history-op-btn",()=>{w("operations-hub-modal"),K()}),e("sim-add-new-item-btn",Pt),e("sim-preview-invoice-btn",Ct),e("sim-save-draft-btn",At),e("sim-finalize-btn",Nt),t("sim-select-all-chk",i=>{if(i.target.checked){const c=document.querySelectorAll("#sim-available-items .op-item-card.available:not(.added)");c.length===0?d("Nenhum item disponível para adicionar.","info"):(c.forEach(s=>{const l=s.querySelector(".btn-add-op");l&&l.click()}),d(`${c.length} item(ns) adicionado(s) à simulação.`,"success")),i.target.checked=!1}}),n("searchInput",N),t("sortSelect",N),t("filterSelect",N),e("confirm-modal-cancel-btn",()=>w("confirm-modal")),document.querySelectorAll(".closeModalBtn").forEach(i=>{var s;const c=(s=i.closest(".modal-backdrop"))==null?void 0:s.id;c&&i.addEventListener("click",()=>w(c))}),e("reset-user-form-btn",Q),t("itemImageInput",i=>$e(i,"imagePreview","imagePlaceholder")),e("reports-tab-nav",i=>{i.target.matches(".report-tab")&&Pe(i.target,i.target.dataset.tab)}),t("reports-period-filter",Te),t("daily-movements-date-picker",Me),e("save-operation-btn",$t),e("toggle-password-btn",i=>{if(i.target.id==="password")return;const c=document.getElementById("password"),s=document.querySelector(".password-toggle-icon");c.type==="password"?(c.type="text",s.setAttribute("data-feather","eye")):(c.type="password",s.setAttribute("data-feather","eye-off")),feather.replace()}),feather.replace()}async function ve(){const e=new Date().toISOString();try{console.log("Starting Backup: Fetching data...");const[{data:t},{data:n},{data:a},{data:o},{data:r},{data:i}]=await Promise.all([y.from("items").select("*"),y.from("suppliers").select("*"),y.from("movements").select("*"),y.from("operations").select("*"),y.from("profiles").select("*"),y.from("purchase_orders").select("*")]),s=JSON.stringify({metadata:{version:"1.0",timestamp:e,app:"StockControl Pro"},schema_notes:["This backup contains raw data from Supabase tables.","Restore process uses 'upsert' (update or insert) based on 'id'."],data:{items:t||[],suppliers:n||[],movements:a||[],operations:o||[],profiles:r||[],purchase_orders:i||[]}},null,2),l=new Blob([s],{type:"application/json"}),p=URL.createObjectURL(l),m=`stock_control_backup_${e.slice(0,10)}.json`,g=document.createElement("a");return g.href=p,g.download=m,document.body.appendChild(g),g.click(),document.body.removeChild(g),console.log("Backup downloaded successfully."),d("Backup realizado com sucesso! Download iniciado.","success"),!0}catch(t){return console.error("Backup failed:",t),d("Erro ao criar backup: "+t.message,"danger"),!1}}async function Rt(e){if(!e)return;const t=new FileReader;return new Promise((n,a)=>{t.onload=async o=>{try{const r=JSON.parse(o.target.result);if(!r.data||!r.metadata)throw new Error("Arquivo de backup inválido (formato incorreto).");console.log("Starting Restore...");const i=async(c,s)=>{if(!s||s.length===0)return;console.log(`Restoring ${c} (${s.length} records)...`);const{error:l}=await y.from(c).upsert(s);if(l)throw new Error(`Falha ao restaurar ${c}: ${l.message}`)};await i("suppliers",r.data.suppliers),await i("items",r.data.items),r.data.profiles&&await i("profiles",r.data.profiles),await i("operations",r.data.operations),await i("movements",r.data.movements),await i("purchase_orders",r.data.purchase_orders),console.log("Restore completed. Reloading app data..."),await ce(),P(),d("Restauração concluída com sucesso!","success"),n(!0)}catch(r){console.error("Restore failed:",r),d("Erro na restauração: "+r.message,"danger"),a(r)}},t.onerror=o=>a(o),t.readAsText(e)})}async function zt(){console.log("Iniciando migração de operações para UUIDs...");let e=0,t=0;const n=[];for(const a of I){let o=!1;!a.items||!Array.isArray(a.items)||(a.items.forEach(r=>{if(r.item_id)return;let i=null;if(r.supplier_id||r.supplierId){const c=r.supplier_id||r.supplierId;i=u.find(s=>s.code===r.code&&s.supplier_id===c)}else a.type;i&&(r.item_id=i.id,o=!0,t++)}),a.nfeData&&Array.isArray(a.nfeData)&&a.nfeData.forEach(r=>{var s;const i=(s=r.fornecedor)!=null&&s.cnpj?V(r.fornecedor.cnpj):null,c=v.find(l=>V(l.cnpj)===i);c&&r.produtos&&r.produtos.forEach(l=>{if(l.item_id)return;const p=u.find(m=>m.code===l.code&&m.supplier_id===c.id);p&&(l.item_id=p.id,o=!0,t++)})}),a.suppliers&&Array.isArray(a.suppliers)&&a.suppliers.forEach(r=>{r.items.forEach(i=>{if(!i.item_id){if(a.nfeData)for(const c of a.nfeData){if(!c.produtos)continue;const s=c.produtos.find(l=>l.name===i.desc&&l.item_id);if(s){i.item_id=s.item_id,o=!0,t++;return}}if(i.code){const c=r.id;if(c){const s=u.find(l=>l.code===i.code&&l.supplier_id===c);s&&(i.item_id=s.id,o=!0,t++)}}}})}),o&&(n.push(st(a.id,a)),e++))}if(n.length>0){d(`Migrando ${e} operações e ${t} itens...`,"info");try{await Promise.all(n),d(`Migração concluída! ${e} operações atualizadas.`,"success"),console.log(`Sucesso: ${e} operações atualizadas com ${t} itens vinculados.`),P()}catch(a){console.error("Erro na migração:",a),d(`Erro parcial na migração: ${a.message}`,"danger")}}else d("Nenhuma operação precisou de atualização. Tudo certo!","success")}const W={XML_UPLOAD_URL:"/api/upload/",API_KEY_HEADER:"Authorization",API_KEY_VALUE:"secret"};let G=[],R=[];async function jt(e){console.log("Attempting to initialize app for user:",e),console.log("Fetching full user profile...");const t=await oe(e);if(console.log("Full user profile fetched:",t),!t){console.error("Could not get user profile. Aborting app initialization and logging out."),d("Sessão inválida ou perfil não encontrado. Por favor, faça login novamente.","danger"),await U();return}console.log("Usuário autenticado com perfil. Inicializando a aplicação...",t),re(t),document.getElementById("login-screen").classList.add("hidden"),document.getElementById("app-container").classList.remove("hidden"),Le(t);try{await ce(),P();const n=window.location.hash,a=sessionStorage.getItem("simulationReturnData");if(a){sessionStorage.removeItem("simulationReturnData");const o=JSON.parse(a);Mt(o)}else n.includes("#operations-history")?K():n.includes("#purchase-orders")?ae():n.includes("#menu")?X("menu"):X("dashboard")}catch(n){console.error("Falha ao inicializar a aplicação:",n),d(`Erro crítico ao carregar dados: ${n.message}. Por favor, recarregue a página.`,"danger",1e4),await U()}}function Ht(){console.log("Usuário deslogado. Desligando a aplicação."),re(null),document.getElementById("login-screen").classList.remove("hidden"),document.getElementById("app-container").classList.add("hidden"),u.length=0,I.length=0,v.length=0}document.addEventListener("DOMContentLoaded",()=>{y.auth.onAuthStateChange(async(r,i)=>{console.log("--- Auth State Change ---"),console.log("Event:",r),console.log("Session exists:",!!i),i?(console.log("Session found. Calling initializeApp..."),jt(i.user)):(console.log("No session found. Shutting down app."),Ht()),console.log("--- End Auth State Change ---")}),document.getElementById("login-form").addEventListener("submit",async r=>{r.preventDefault();const i=document.getElementById("email").value,c=document.getElementById("password").value,s=r.target.querySelector("button");s.disabled=!0,s.textContent="A entrar...",await Ee(i,c),s.disabled=!1,s.textContent="Entrar"}),Ft();const e=document.getElementById("desktop-backup-btn");e&&e.addEventListener("click",()=>{B("backup-modal")});const t=document.getElementById("btn-do-backup");t&&t.addEventListener("click",async()=>{t.disabled=!0,t.textContent="Gerando Backup...",await ve(),t.disabled=!1,t.textContent="Baixar Backup Agora"});const n=document.getElementById("btn-trigger-restore"),a=document.getElementById("backup-file-input");n&&a&&(n.addEventListener("click",()=>{a.click()}),a.addEventListener("change",async r=>{const i=r.target.files[0];a.value="",i&&M("Restaurar Backup?",`ATENÇÃO: Restaurar um backup irá sobrescrever dados existentes com o mesmo ID.
Pode haver perda de dados recentes se o backup for antigo.

Tem certeza que deseja continuar?`,async()=>{n.disabled=!0,n.textContent="Restaurando...";try{await Rt(i),w("backup-modal")}catch{}finally{n.disabled=!1,n.textContent="Selecionar Arquivo..."}})}));const o=document.getElementById("btn-run-migration");o&&o.addEventListener("click",async()=>{d("Iniciando backup de segurança...","info"),await ve(),M("Iniciar Migração de UUIDs?",`Isso irá atualizar todas as operações existentes para usar o novo vínculo seguro de itens. Um backup foi baixado automaticamente.

Deseja continuar?`,async()=>{o.disabled=!0,o.textContent="Migrando...",await zt(),o.disabled=!1,o.textContent="Rodar Migração (UUID)"})}),document.querySelector(".bottom-nav").addEventListener("click",r=>{const i=r.target.closest(".nav-item");if(!i)return;r.preventDefault();const c=i.id.split("-")[1];c==="reports"?De():c==="operations"?B("operations-hub-modal"):X(c)}),document.getElementById("xml-upload-main").addEventListener("change",Vt),window.addEventListener("storage",r=>{})});async function Vt(e){if(!_("import")){d("Não tem permissão para importar ficheiros.","danger");return}const t=e.target.files[0];if(!t)return;d("Processando NF-e XML no servidor...","info");const n=new FormData;n.append("file",t);try{const a=await fetch(W.XML_UPLOAD_URL,{method:"POST",headers:{[W.API_KEY_HEADER]:W.API_KEY_VALUE},body:n});if(!a.ok){const r=await a.json();throw new Error(r.detail||`Erro do servidor: ${a.statusText}`)}const o=await a.json();if(!o||!o.produtos||o.produtos.length===0)throw new Error("Nenhum produto encontrado no XML processado pelo servidor.");d("XML processado com sucesso!","success"),Jt(o)}catch(a){console.error("Falha ao processar XML via backend:",a),d(`Falha ao processar XML: ${a.message}`,"danger")}finally{e.target.value=""}}function Jt(e){var a,o;const t=v.find(r=>r.cnpj===e.fornecedor.cnpj);e.produtos.forEach(r=>{let i=null;const c=(r.name.match(/(\d+\s*[xX]\s*\d+)/)||[])[0];if(c&&(i=c.toUpperCase().replace(" ","")),!i&&t){const s=u.find(l=>l.code===r.code&&l.supplierId===t.id);s&&s.unitsPerPackage>0&&s.unitMeasureValue>0&&(i=`${s.unitsPerPackage}X${s.unitMeasureValue}`)}if(!i){const s=(r.name.match(/(\d+)\s*(?:G|GR|KG)/i)||[])[1];s&&(i=s.trim())}r.qtyUnit=i||""}),G.push(e),R.push(...e.produtos);const n=document.getElementById("extraction-summary");n.innerHTML=`
        <p><strong>Fornecedor:</strong> ${S(((a=e.fornecedor)==null?void 0:a.nome)||"N/A")}</p>
        <p><strong>Itens nesta nota:</strong> ${((o=e.produtos)==null?void 0:o.length)||0}</p>
        <p><strong>Total de itens acumulados:</strong> ${R.length}</p>
    `,document.getElementById("menu-action-save-stock").style.display="none",document.getElementById("menu-action-load-another").onclick=()=>{w("extraction-menu-modal"),document.getElementById("xml-upload-main").click()},document.getElementById("menu-action-perform-op").onclick=Qt,document.getElementById("menu-action-cancel").onclick=()=>{je(),w("extraction-menu-modal"),d("Operação cancelada.","warning")},B("extraction-menu-modal")}function je(){G=[],R=[]}async function Qt(){if(R.length===0){d("Nenhum item carregado para realizar a operação.","warning");return}const e=L();if(!e){d("Usuário não autenticado. Não é possível salvar a operação.","danger");return}const t=document.getElementById("loading-overlay");t.classList.remove("hidden");const n=`OP-${Date.now()}`,a={id:n,user_id:e.id,invoiceNumber:n.replace("OP-",""),date:new Date().toISOString(),items:[...R],nfeData:[...G],type:"import"};try{await se(a),I.push(a),await Lt(G,a.id),je(),w("extraction-menu-modal"),d(`Operação ${a.id} criada e salva com sucesso!`,"success"),le(a.id,"invoice")}catch(o){d(`Erro ao salvar operação no banco de dados: ${o.message}`,"danger"),console.error("Falha ao salvar operação:",o)}finally{t.classList.add("hidden")}}
