# Documento de Orientação: Extrator Robusto de XML NF-e

## 1. Objetivo

Este documento define as regras de negócios para um extrator de dados robusto, focado em arquivos XML de Nota Fiscal Eletrônica (NF-e) brasileira. O objetivo é extrair dados específicos, lidando com tags ausentes ou dados inconsistentes através de uma lógica de *fallback* (Plano A, B, C).

## 2. Namespace

**Aviso:** Todas as buscas por tags (exceto em XMLs sem namespace) devem usar o namespace padrão da NF-e: `http://www.portalfiscal.inf.br/nfe`.

## 3. Dados Gerais da Nota (Buscar 1x por XML)

Busque estas informações no cabeçalho da nota.

### Campo: Peso Líquido (Total)

* **Plano A (Leitura Direta):**
    1.  Busque a tag `<infNFe><transp><vol><pesoL>`.
    2.  Se a tag existir e seu valor for maior que `0`, use este valor.
* **Plano B (Fallback por Cálculo):**
    1.  Se o Plano A falhar (tag ausente ou valor `0`):
    2.  Execute a lógica do **Campo 5.7 (QTY KG)** para CADA item (`<det>`) na nota.
    3.  Some os resultados. O valor final desta soma será o Peso Líquido.
* **Plano C (Falha Segura):**
    1.  Se o Plano A e B falharem, retorne `0`.

### Campo: Peso Bruto (Total)

* **Plano A (Leitura Direta):**
    1.  Busque a tag `<infNFe><transp><vol><pesoB>`.
    2.  Se a tag existir e seu valor for maior que `0`, use este valor.
* **Plano B (Fallback para Peso Líquido):**
    1.  Se o Plano A falhar (tag ausente ou valor `0`):
    2.  Use o valor final obtido no campo **Peso Líquido** (seja do Plano A ou B dele).
* **Plano C (Falha Segura):**
    1.  Se o Plano A e B falharem, retorne `0`.

## 4. Dados por Item (Iterar em cada `<det>`)

Execute esta lógica para cada bloco `<det>` encontrado no XML.

### 4.1. Campo: QNT / QTY UNIT (Quantidade Comercial)

* **Plano A:** Leia o valor numérico de `<det><prod><qCom>`.
* **Plano B:** Se `<qCom>` não existir, leia o valor numérico de `<det><prod><qTrib>`.
* **Plano C:** Se ambos faltarem, retorne `0`.

### 4.2. Campo: U/M (Unidade de Medida Comercial)

* **Plano A:** Leia o texto de `<det><prod><uCom>`.
* **Plano B:** Se `<uCom>` não existir, leia o texto de `<det><prod><uTrib>`.
* **Plano C:** Se ambos faltarem, retorne `N/A`.

### 4.3. Campo: DESCRIPTION (Descrição)

* **Plano A:** Leia o texto de `<det><prod><xProd>`.
* **Plano C:** Se faltar, retorne `N/A` (ou string vazia).

### 4.4. Campo: NCM

* **Plano A:** Leia o texto de `<det><prod><NCM>`.
* **Plano C:** Se faltar, retorne `N/A` (ou string vazia).

### 4.5. Campo: UNIT $ (BRL) (Valor Unitário Comercial)

* **Plano A:** Leia o valor numérico de `<det><prod><vUnCom>`.
* **Plano B (Cálculo):** Se `<vUnCom>` não existir ou for `0`:
    1.  Leia `<vProd>` (Valor Total) e `<qCom>` (Quantidade).
    2.  Se `vProd` > 0 e `qCom` > 0, calcule: `vProd / qCom`.
* **Plano C:** Se "A" e "B" falharem, retorne `0`.

### 4.6. Campo: $ BRL (Total) (Valor Total do Item em BRL)

* **Plano A:** Leia o valor numérico de `<det><prod><vProd>`.
* **Plano B (Cálculo):** Se `<vProd>` não existir ou for `0`:
    1.  Leia `<vUnCom>` (Valor Unitário) e `<qCom>` (Quantidade).
    2.  Calcule: `vUnCom * qCom`.
* **Plano C:** Se "A" e "B" falharem, retorne `0`.

---
## 5. Lógica Crítica: Campo 4.7 QTY KG (Quantidade em KG)

Esta é a lógica mais complexa e deve ser seguida estritamente para garantir a leitura correta dos dados fiscais.

* **Plano A (Leitura Fiscal / Tributável):**
    1.  Leia a unidade de medida em `<det><prod><uTrib>` (normalize para maiúsculas, ex: "KG").
    2.  **Se `uTrib` == "KG"**: O valor é o de `<det><prod><qTrib>`. **PARE AQUI.**
    3.  **Se `uTrib` == "G" OU `uTrib` == "GR"**: O valor é `(<det><prod><qTrib> / 1000)`. **PARE AQUI.**
    4.  **Se `uTrib` == "T"**: O valor é `(<det><prod><qTrib> * 1000)`. **PARE AQUI.**

* **Plano B (Fallback Comercial):**
    1.  Execute este plano **somente se** o Plano A falhar (ou seja, `<uTrib>` é "UN", "CX", "FD", "PC", ou está ausente).
    2.  Leia a unidade de medida em `<det><prod><uCom>` (normalize para maiúsculas).
    3.  **Se `uCom` == "KG"**: O valor é o de `<det><prod><qCom>`. **PARE AQUI.**
    4.  **Se `uCom` == "G" OU `uCom` == "GR"**: O valor é `(<det><prod><qCom> / 1000)`. **PARE AQUI.**
    5.  **Se `uCom` == "T"**: O valor é `(<det><prod><qCom> * 1000)`. **PARE AQUI.**

* **Plano C (Falha Segura):**
    1.  Se o Plano A e o Plano B falharem (ambas as unidades são "UN", "CX", etc.), retorne `0`.

### 6. Aviso de Integridade de Dados vs. Extração

O trabalho deste extrator é ler fielmente os dados **declarados** no XML, não auditá-los.

*Exemplo de Erro no XML:*
* `<xProd>` (Descrição) diz: "Biscoito 100G"
* `<qCom>` (Quantidade) diz: "720" (unidades)
* `<uTrib>` (Unid. Fiscal) diz: "KG"
* `<qTrib>` (Qtd. Fiscal) diz: "7200.0"

*Cálculo Lógico (Auditoria):* 720 unidades * 0.100 kg = **72 kg**.
*Valor Declarado (Extração):* **7200 kg**.

Neste caso, o **Plano A** da lógica (Seção 4.7) será acionado. O extrator **deve** reportar **7200** como o `QTY KG`, pois essa foi a informação fiscal estruturada e declarada ao Fisco. A discrepância é um erro na emissão da NF-e, e não no extrator.